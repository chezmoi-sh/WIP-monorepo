# Copyright 2024
#
# Everyone is permitted to copy, distribute, modify, merge, sell, publish,
# sublicense or whatever the fuck they want with this software but at their
# OWN RISK.
# The author has absolutely no fucking clue what the code in this project
# does. It might just fucking work or not, there is no third option.
#
# IN NO EVENT SHALL THE AUTHORS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
# DEALINGS IN THE SOFTWARE.
---
name: üíö Validate Instrastructure-as-code

on:
  merge_group: {}
  pull_request: {}

permissions: {}

jobs:
  validate_infrastructure:
    name: ‚úÖ Validate Terraform configuration
    permissions:
      contents: read
    runs-on: ubuntu-latest
    steps:
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: üîçÔ∏è Verify if anything related to Terraform has changed
        uses: tj-actions/verify-changed-files@d774a4c7ebe335445d79c7b44138f56a76058ba0 # v19.0.0
        id: verify-changed-files
        with:
          files: |
            .github/workflows/merge_group,pull_request.terraform.validate.yaml
            infrastructure/live/external/**

      - name: üöß Setup Terraform
        uses: hashicorp/setup-terraform@a1502cd9e758c50496cc9ac5308c4843bcd56d36 # v3.0.0
        if: steps.verify-changed-files.outputs.files-changed == 'true'
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: ‚úÖ Validate Terraform files
        if: steps.verify-changed-files.outputs.files-changed == 'true'
        run: |
          terraform init
          terraform validate
          terraform fmt -check
